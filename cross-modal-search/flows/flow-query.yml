jtype: Flow
version: '1'
with:
  prefetch: 10
  port_expose: $JINA_PORT
  workspace: $JINA_WORKSPACE
pods:
  - name: loader                          # load images from the dataset of image-caption pairs
    uses: ImageReader
    py_modules: 'flows/executors.py'
    read_only: true
    needs: [gateway]
  - name: image_encoder                               # encode images into embeddings with CLIP model
    uses: 'jinahub+docker://CLIPImageEncoder'
    volumes: $HOME/.cache/clip:/root/.cache/clip
    timeout_ready: 600000
    read_only: true
  - name: text_indexer                                # index the text into documents
    uses: 'jinahub+docker://SimpleIndexer'
    volumes: $JINA_WORKSPACE_MOUNT
    uses_with:
     index_file_name: 'text_index'
    needs: image_encoder
    read_only: true
  - name: text_filter
    uses: TextFilter
    py_modules: 'flows/executors.py'
    needs: [gateway]
  - name: text_encoder                                # encode text into embeddings with CLIP model
    uses: 'jinahub+docker://CLIPTextEncoder'
    timeout_ready: 600000
    read_only: true
    needs: text_filter
  - name: image_indexer                        # store image embeddings
    uses: 'jinahub+docker://SimpleIndexer'
    volumes: $JINA_WORKSPACE_MOUNT
    uses_with:
      index_file_name: 'image_index'
    read_only: true
    needs: text_encoder
  - name: join_all                                    # wait on the 3 executors to finish data processing with "needs"
    needs: [image_indexer, text_indexer]
